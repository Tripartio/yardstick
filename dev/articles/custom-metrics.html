<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="yardstick">
<title>Custom metrics • yardstick</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><link href="../deps/_Source%20Sans%20Pro-0.4.0/font.css" rel="stylesheet">
<link href="../deps/_Source%20Code%20Pro-0.4.0/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Custom metrics">
<meta property="og:description" content="yardstick">
<meta property="og:image" content="https://yardstick.tidymodels.org/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="yardstick.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">yardstick</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.0.9.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/custom-metrics.html">Custom metrics</a>
    <a class="dropdown-item" href="../articles/metric-types.html">Metric types</a>
    <a class="dropdown-item" href="../articles/multiclass.html">Multiclass averaging</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tidymodels/yardstick/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Custom metrics</h1>
                        <h4 data-toc-skip class="author">Davis Vaughan</h4>
            
            <h4 data-toc-skip class="date">2022-03-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/yardstick/blob/HEAD/vignettes/custom-metrics.Rmd" class="external-link"><code>vignettes/custom-metrics.Rmd</code></a></small>
      <div class="d-none name"><code>custom-metrics.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/yardstick" class="external-link">yardstick</a></span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="custom-metrics">Custom metrics<a class="anchor" aria-label="anchor" href="#custom-metrics"></a>
</h2>
<p><code>yardstick</code> already includes a large number of metrics, but there’s obviously a chance that you might have a custom metric that hasn’t been implemented yet. In that case, you can use a few of the tools <code>yardstick</code> exposes to create custom metrics.</p>
<p>Why create custom metrics? With the infrastructure <code>yardstick</code> provides, you get:</p>
<ul>
<li>Standardization between your metric and other preexisting metrics</li>
<li>Automatic error handling for types and lengths</li>
<li>Automatic selection of binary / multiclass metric implementations</li>
<li>Automatic <code>NA</code> handling</li>
<li>Support for grouped data frames</li>
<li>Support for use alongside other metrics in <code><a href="../reference/metric_set.html">metric_set()</a></code>
</li>
</ul>
<p>The implementation metrics differ slightly depending on whether you are implementing a numeric, class or class probability metric. Examples for numeric and classification metrics are given below. I would encourage you to look into the implementation of <code><a href="../reference/roc_auc.html">roc_auc()</a></code> after reading this vignette if you want to work on a class probability metric.</p>
</div>
<div class="section level2">
<h2 id="numeric-example---mean-squared-error">Numeric example - Mean squared error<a class="anchor" aria-label="anchor" href="#numeric-example---mean-squared-error"></a>
</h2>
<p>Mean squared error (from here on, <code>mse()</code>) is a numeric metric that measures the average of the squared errors. Numeric metrics are generally the simplest to create with <code>yardstick</code>, as they do not have multiclass implementations. The formula for <code>mse()</code> is:</p>
<p><span class="math display">\[ MSE = \frac{1}{N} \sum_{i=1}^{N} (truth_i - estimate_i) ^ 2 = mean( (truth - estimate) ^ 2) \]</span></p>
<p>All metrics should have a data frame version, and a vector version. The data frame version here will be named <code>mse()</code>, and the vector version will be <code>mse_vec()</code>.</p>
<div class="section level3">
<h3 id="vector-implementation">Vector implementation<a class="anchor" aria-label="anchor" href="#vector-implementation"></a>
</h3>
<p>To start, create the vector version. Generally, all metrics have the same arguments unless the metric requires an extra parameter (such as <code>beta</code> in <code><a href="../reference/f_meas.html">f_meas()</a></code>). To create the vector function, you need to do two things:</p>
<ol style="list-style-type: decimal">
<li>Create an internal implementation function, <code>mse_impl()</code>.</li>
<li>Pass on that implementation function to <code><a href="../reference/metric_vec_template.html">metric_vec_template()</a></code>.</li>
</ol>
<p>Below, <code>mse_impl()</code> contains the actual implementation of the metric, and takes <code>truth</code> and <code>estimate</code> as arguments along with any metric specific arguments.</p>
<p><code><a href="../reference/metric_vec_template.html">metric_vec_template()</a></code> is a <code>yardstick</code> function that accepts the implementation function along with the other arguments to <code>mse_vec()</code> and actually executes <code>mse_impl()</code>. Additionally, it has a <code>cls</code> argument to specify the allowed class type of <code>truth</code> and <code>estimate</code>. If the classes are the same, a single character class can be passed, and if they are different a character vector of length 2 can be supplied.</p>
<p>The <code><a href="../reference/metric_vec_template.html">metric_vec_template()</a></code> helper handles the removal of <code>NA</code> values in your metric, so your implementation function does not have to worry about them. It performs type checking using <code>cls</code> and also checks that the <code>estimator</code> is valid, the second of which is covered in the classification example. This way, all you have to worry about is the core implementation.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mse_vec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimate</span>, <span class="va">na_rm</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">mse_impl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">truth</span> <span class="op">-</span> <span class="va">estimate</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="fu"><a href="../reference/metric_vec_template.html">metric_vec_template</a></span><span class="op">(</span>
    metric_impl <span class="op">=</span> <span class="va">mse_impl</span>,
    truth <span class="op">=</span> <span class="va">truth</span>, 
    estimate <span class="op">=</span> <span class="va">estimate</span>,
    na_rm <span class="op">=</span> <span class="va">na_rm</span>,
    cls <span class="op">=</span> <span class="st">"numeric"</span>,
    <span class="va">...</span>
  <span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p>At this point, you’ve created the vector version of the mean squared error metric.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"solubility_test"</span><span class="op">)</span>

<span class="fu">mse_vec</span><span class="op">(</span>
  truth <span class="op">=</span> <span class="va">solubility_test</span><span class="op">$</span><span class="va">solubility</span>, 
  estimate <span class="op">=</span> <span class="va">solubility_test</span><span class="op">$</span><span class="va">prediction</span>
<span class="op">)</span>
<span class="co">#&gt; [1] 0.5214438</span></code></pre></div>
<p>Intelligent error handling is immediately available.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mse_vec</span><span class="op">(</span>truth <span class="op">=</span> <span class="st">"apple"</span>, estimate <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `validate_class()`:</span></span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `truth` should be a numeric but a character was supplied.</span>

<span class="fu">mse_vec</span><span class="op">(</span>truth <span class="op">=</span> <span class="fl">1</span>, estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"xyz"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `validate_class()`:</span></span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `estimate` should be a numeric but a factor was supplied.</span></code></pre></div>
<p><code>NA</code> values are removed if <code>na_rm = TRUE</code> (the default). If <code>na_rm = FALSE</code> and any <code>NA</code> values are detected, then the metric automatically returns <code>NA</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># NA values removed</span>
<span class="fu">mse_vec</span><span class="op">(</span>truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">.5</span>, <span class="fl">.4</span><span class="op">)</span>, estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.6</span>, <span class="fl">.5</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.01</span>

<span class="co"># NA returned</span>
<span class="fu">mse_vec</span><span class="op">(</span>truth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">.5</span>, <span class="fl">.4</span><span class="op">)</span>, estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.6</span>, <span class="fl">.5</span><span class="op">)</span>, na_rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; [1] NA</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-frame-implementation">Data frame implementation<a class="anchor" aria-label="anchor" href="#data-frame-implementation"></a>
</h3>
<p>The data frame version of the metric should be fairly simple. It is a generic function with a <code>data.frame</code> method that calls the <code>yardstick</code> helper, <code><a href="../reference/metric_summarizer.html">metric_summarizer()</a></code>, and passes along the <code>mse_vec()</code> function to it along with versions of <code>truth</code> and <code>estimate</code> that have been wrapped in <code><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">rlang::enquo()</a></code> and then unquoted with <code>!!</code> so that non-standard evaluation can be supported. Additionally, the generic itself has been wrapped in <code><a href="../reference/new-metric.html">new_numeric_metric()</a></code> to formalize it as a numeric metric function. This allows the metric to work with <code><a href="../reference/metric_set.html">metric_set()</a></code> and the tune package.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rlang.r-lib.org" class="external-link">rlang</a></span><span class="op">)</span>

<span class="va">mse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"mse"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new-metric.html">new_numeric_metric</a></span><span class="op">(</span><span class="va">mse</span>, direction <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span>

<span class="va">mse.data.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">truth</span>, <span class="va">estimate</span>, <span class="va">na_rm</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="fu"><a href="../reference/metric_summarizer.html">metric_summarizer</a></span><span class="op">(</span>
    metric_nm <span class="op">=</span> <span class="st">"mse"</span>,
    metric_fn <span class="op">=</span> <span class="va">mse_vec</span>,
    data <span class="op">=</span> <span class="va">data</span>,
    truth <span class="op">=</span> <span class="op">!</span><span class="op">!</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">truth</span><span class="op">)</span>,
    estimate <span class="op">=</span> <span class="op">!</span><span class="op">!</span> <span class="fu"><a href="https://rlang.r-lib.org/reference/enquo.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>, 
    na_rm <span class="op">=</span> <span class="va">na_rm</span>,
    <span class="va">...</span>
  <span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p>And that’s it. <code>yardstick</code> handles the rest with an internal call to <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">mse</span><span class="op">(</span><span class="va">solubility_test</span>, truth <span class="op">=</span> <span class="va">solubility</span>, estimate <span class="op">=</span> <span class="va">prediction</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span>
<span class="co">#&gt;   .metric .estimator .estimate</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> mse     standard       0.521</span>

<span class="co"># Error handling</span>
<span class="fu">mse</span><span class="op">(</span><span class="va">solubility_test</span>, truth <span class="op">=</span> <span class="va">solubility</span>, estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"xyz"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `dplyr::summarise()`:</span></span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> Problem while computing `.estimate = metric_fn(truth =</span>
<span class="co">#&gt;   solubility, estimate = factor("xyz"), na_rm = na_rm)`.</span>
<span class="co">#&gt; <span style="font-weight: bold;">Caused by error in `validate_class()`:</span></span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `estimate` should be a numeric but a factor was supplied.</span></code></pre></div>
<p>Let’s test it out on a grouped data frame.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span>
<span class="va">size</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">times</span> <span class="op">&lt;-</span> <span class="fl">10</span>

<span class="co"># create 10 resamples</span>
<span class="va">solubility_resampled</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>
    n <span class="op">=</span> <span class="va">times</span>,
    expr <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="va">solubility_test</span>, <span class="va">size</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    simplify <span class="op">=</span> <span class="cn">FALSE</span>
  <span class="op">)</span>,
  .id <span class="op">=</span> <span class="st">"resample"</span>
<span class="op">)</span>

<span class="va">solubility_resampled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">resample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">mse</span><span class="op">(</span><span class="va">solubility</span>, <span class="va">prediction</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 4</span></span>
<span class="co">#&gt;    resample .metric .estimator .estimate</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1        mse     standard       0.512</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 10       mse     standard       0.454</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 2        mse     standard       0.513</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 3        mse     standard       0.414</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 4        mse     standard       0.543</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 5        mse     standard       0.456</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 6        mse     standard       0.652</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 7        mse     standard       0.642</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 8        mse     standard       0.404</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 9        mse     standard       0.479</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="class-example---miss-rate">Class example - Miss rate<a class="anchor" aria-label="anchor" href="#class-example---miss-rate"></a>
</h2>
<p>Miss rate is another name for the False Negative Rate, and is a classification metric in the same family as <code><a href="../reference/sens.html">sens()</a></code> and <code><a href="../reference/spec.html">spec()</a></code>. It follows the formula:</p>
<p><span class="math display">\[ miss\_rate = \frac{FN}{FN + TP} \]</span></p>
<p>This metric, like other classification metrics, is more easily computed when expressed as a confusion matrix. As you will see in the example, you can achieve this with a call to <code>base::table(estimate, truth)</code> which correctly puts the “correct” result in the columns of the confusion matrix.</p>
<p>Classification metrics are more complicated than numeric ones because you have to think about extensions to the multiclass case. For now, let’s start with the binary case.</p>
<div class="section level3">
<h3 id="vector-implementation-1">Vector implementation<a class="anchor" aria-label="anchor" href="#vector-implementation-1"></a>
</h3>
<p>The vector implementation for classification metrics initially has the same setup as numeric metrics, but has two additional arguments.</p>
<p><code>estimator</code> determines the type of estimator to use (binary or some kind of multiclass implementation or averaging). This argument is auto-selected for the user, so default it to <code>NULL</code>. Additionally, pass it along to <code><a href="../reference/metric_vec_template.html">metric_vec_template()</a></code> so that it can check the provided <code>estimator</code> against the classes of <code>truth</code> and <code>estimate</code> to see if they are allowed.</p>
<p><code>event_level</code> determines which level of <code>truth</code> should be considered the “event” when <code>truth</code> is a binary factor. The two options are <code>"first"</code>, and <code>"second"</code>, but you should default it to <code>"first"</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Logic for `event_level`</span>
<span class="va">event_col</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">xtab</span>, <span class="va">event_level</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">event_level</span>, <span class="st">"first"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">xtab</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">xtab</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">miss_rate_vec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, 
                          <span class="va">estimate</span>, 
                          <span class="va">estimator</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                          <span class="va">na_rm</span> <span class="op">=</span> <span class="cn">TRUE</span>, 
                          <span class="va">event_level</span> <span class="op">=</span> <span class="st">"first"</span>,
                          <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">estimator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/developer-helpers.html">finalize_estimator</a></span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimator</span><span class="op">)</span>
  
  <span class="va">miss_rate_impl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Create </span>
    <span class="va">xtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">truth</span><span class="op">)</span>
    <span class="va">col</span> <span class="op">&lt;-</span> <span class="fu">event_col</span><span class="op">(</span><span class="va">xtab</span>, <span class="va">event_level</span><span class="op">)</span>
    <span class="va">col2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">xtab</span><span class="op">)</span>, <span class="va">col</span><span class="op">)</span>
    
    <span class="va">tp</span> <span class="op">&lt;-</span> <span class="va">xtab</span><span class="op">[</span><span class="va">col</span>, <span class="va">col</span><span class="op">]</span>
    <span class="va">fn</span> <span class="op">&lt;-</span> <span class="va">xtab</span><span class="op">[</span><span class="va">col2</span>, <span class="va">col</span><span class="op">]</span>
    
    <span class="va">fn</span> <span class="op">/</span> <span class="op">(</span><span class="va">fn</span> <span class="op">+</span> <span class="va">tp</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="fu"><a href="../reference/metric_vec_template.html">metric_vec_template</a></span><span class="op">(</span>
    metric_impl <span class="op">=</span> <span class="va">miss_rate_impl</span>,
    truth <span class="op">=</span> <span class="va">truth</span>,
    estimate <span class="op">=</span> <span class="va">estimate</span>,
    na_rm <span class="op">=</span> <span class="va">na_rm</span>,
    cls <span class="op">=</span> <span class="st">"factor"</span>,
    estimator <span class="op">=</span> <span class="va">estimator</span>,
    <span class="va">...</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Another change from the numeric metric is that a call to <code><a href="../reference/developer-helpers.html">finalize_estimator()</a></code> is made. This is the infrastructure that auto-selects the type of estimator to use.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"two_class_example"</span><span class="op">)</span>
<span class="fu">miss_rate_vec</span><span class="op">(</span><span class="va">two_class_example</span><span class="op">$</span><span class="va">truth</span>, <span class="va">two_class_example</span><span class="op">$</span><span class="va">predicted</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.120155</span></code></pre></div>
<p>What happens if you try and pass in a multiclass result?</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"hpc_cv"</span><span class="op">)</span>
<span class="va">fold1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">hpc_cv</span>, <span class="va">Resample</span> <span class="op">==</span> <span class="st">"Fold01"</span><span class="op">)</span>
<span class="fu">miss_rate_vec</span><span class="op">(</span><span class="va">fold1</span><span class="op">$</span><span class="va">obs</span>, <span class="va">fold1</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span>
<span class="co">#&gt;          F          M          L </span>
<span class="co">#&gt; 0.06214689 0.00000000 0.00000000</span></code></pre></div>
<p>This isn’t great, as currently multiclass <code>miss_rate()</code> isn’t supported and it would have been better to throw an error if the <code>estimator</code> was not <code>"binary"</code>. Currently, <code><a href="../reference/developer-helpers.html">finalize_estimator()</a></code> uses its default implementation which selected <code>"macro"</code> as the <code>estimator</code> since <code>truth</code> was a factor with more than 2 classes. When we implement multiclass averaging, this is what you want, but if your metric only works with a binary implementation (or has other specialized multiclass versions), you might want to guard against this.</p>
<p>To fix this, a generic counterpart to <code><a href="../reference/developer-helpers.html">finalize_estimator()</a></code>, called <code><a href="../reference/developer-helpers.html">finalize_estimator_internal()</a></code>, exists that helps you restrict the input types. If you provide a method to <code><a href="../reference/developer-helpers.html">finalize_estimator_internal()</a></code> where the method name is the same as your metric name, and then set the <code>metric_class</code> argument in <code><a href="../reference/developer-helpers.html">finalize_estimator()</a></code> to be the same thing, you can control how the auto-selection of the <code>estimator</code> is handled.</p>
<p>Don’t worry about the <code>metric_dispatcher</code> argument. This is handled for you and just exists as a dummy argument to dispatch off of.</p>
<p>It is also good practice to call <code><a href="../reference/developer-helpers.html">validate_estimator()</a></code> which handles the case where a user passed in the estimator themselves. This validates that the supplied <code>estimator</code> is one of the allowed types and error otherwise.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">finalize_estimator_internal.miss_rate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">metric_dispatcher</span>, <span class="va">x</span>, <span class="va">estimator</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/developer-helpers.html">validate_estimator</a></span><span class="op">(</span><span class="va">estimator</span>, estimator_override <span class="op">=</span> <span class="st">"binary"</span><span class="op">)</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">estimator</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">estimator</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">lvls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lvls</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"A multiclass `truth` input was provided, but only `binary` is supported."</span><span class="op">)</span>
  <span class="op">}</span> 
  
  <span class="st">"binary"</span>
<span class="op">}</span>

<span class="va">miss_rate_vec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, 
                          <span class="va">estimate</span>, 
                          <span class="va">estimator</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                          <span class="va">na_rm</span> <span class="op">=</span> <span class="cn">TRUE</span>, 
                          <span class="va">event_level</span> <span class="op">=</span> <span class="st">"first"</span>,
                          <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># calls finalize_estimator_internal() internally</span>
  <span class="va">estimator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/developer-helpers.html">finalize_estimator</a></span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimator</span>, metric_class <span class="op">=</span> <span class="st">"miss_rate"</span><span class="op">)</span>
  
  <span class="va">miss_rate_impl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Create </span>
    <span class="va">xtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">truth</span><span class="op">)</span>
    <span class="va">col</span> <span class="op">&lt;-</span> <span class="fu">event_col</span><span class="op">(</span><span class="va">xtab</span>, <span class="va">event_level</span><span class="op">)</span>
    <span class="va">col2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">xtab</span><span class="op">)</span>, <span class="va">col</span><span class="op">)</span>
    
    <span class="va">tp</span> <span class="op">&lt;-</span> <span class="va">xtab</span><span class="op">[</span><span class="va">col</span>, <span class="va">col</span><span class="op">]</span>
    <span class="va">fn</span> <span class="op">&lt;-</span> <span class="va">xtab</span><span class="op">[</span><span class="va">col2</span>, <span class="va">col</span><span class="op">]</span>
    
    <span class="va">fn</span> <span class="op">/</span> <span class="op">(</span><span class="va">fn</span> <span class="op">+</span> <span class="va">tp</span><span class="op">)</span>
    
  <span class="op">}</span>
  
  <span class="fu"><a href="../reference/metric_vec_template.html">metric_vec_template</a></span><span class="op">(</span>
    metric_impl <span class="op">=</span> <span class="va">miss_rate_impl</span>,
    truth <span class="op">=</span> <span class="va">truth</span>,
    estimate <span class="op">=</span> <span class="va">estimate</span>,
    na_rm <span class="op">=</span> <span class="va">na_rm</span>,
    cls <span class="op">=</span> <span class="st">"factor"</span>,
    estimator <span class="op">=</span> <span class="va">estimator</span>,
    <span class="va">...</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="co"># Error thrown by our custom handler</span>
<span class="fu">miss_rate_vec</span><span class="op">(</span><span class="va">fold1</span><span class="op">$</span><span class="va">obs</span>, <span class="va">fold1</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span>
<span class="co">#&gt; Error in finalize_estimator_internal.miss_rate(metric_dispatcher, x, estimator): A multiclass `truth` input was provided, but only `binary` is supported.</span>

<span class="co"># Error thrown by validate_estimator()</span>
<span class="fu">miss_rate_vec</span><span class="op">(</span><span class="va">fold1</span><span class="op">$</span><span class="va">obs</span>, <span class="va">fold1</span><span class="op">$</span><span class="va">pred</span>, estimator <span class="op">=</span> <span class="st">"macro"</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `validate_estimator()`:</span></span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `estimator` must be one of: "binary". Not "macro".</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="supporting-multiclass-miss-rate">Supporting multiclass miss rate<a class="anchor" aria-label="anchor" href="#supporting-multiclass-miss-rate"></a>
</h3>
<p>Like many other classification metrics such as <code><a href="../reference/precision.html">precision()</a></code> or <code><a href="../reference/recall.html">recall()</a></code>, miss rate does not have a natural multiclass extension, but one can be created using methods such as macro, weighted macro, and micro averaging. If you have not, I encourage you to read <code><a href="../articles/multiclass.html">vignette("multiclass", "yardstick")</a></code> for more information about how these methods work.</p>
<p>Generally, they require more effort to get right than the binary case, especially if you want to have a performant version. Luckily, a somewhat standard template is used in <code>yardstick</code> and can be used here as well.</p>
<p>Let’s first remove the “binary” restriction we created earlier.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">finalize_estimator_internal.miss_rate</span><span class="op">)</span></code></pre></div>
<p>The main changes below are:</p>
<ul>
<li><p>The binary implementation is moved to <code>miss_rate_binary()</code>.</p></li>
<li><p><code>miss_rate_estimator_impl()</code> is a helper function for switching between binary and multiclass implementations. It also applies the weighting required for multiclass estimators. It is called from <code>miss_rate_impl()</code> and also accepts the <code>estimator</code> argument using R’s function scoping rules.</p></li>
<li><p><code>miss_rate_multiclass()</code> provides the implementation for the multiclass case. It calculates the true positive and false negative values as vectors with one value per class. For the macro case, it returns a vector of miss rate calculations, and for micro, it first sums the individual pieces and returns a single miss rate calculation. In the macro case, the vector is then weighted appropriately in <code>miss_rate_estimator_impl()</code> depending on whether or not it was macro or weighted macro.</p></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">miss_rate_vec</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, 
                          <span class="va">estimate</span>, 
                          <span class="va">estimator</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                          <span class="va">na_rm</span> <span class="op">=</span> <span class="cn">TRUE</span>, 
                          <span class="va">event_level</span> <span class="op">=</span> <span class="st">"first"</span>,
                          <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># calls finalize_estimator_internal() internally</span>
  <span class="va">estimator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/developer-helpers.html">finalize_estimator</a></span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimator</span>, metric_class <span class="op">=</span> <span class="st">"miss_rate"</span><span class="op">)</span>
  
  <span class="va">miss_rate_impl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">truth</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">xtab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="va">truth</span><span class="op">)</span>
    <span class="co"># Rather than implement the actual method here, we rely on</span>
    <span class="co"># an *_estimator_impl() function that can handle binary</span>
    <span class="co"># and multiclass cases</span>
    <span class="fu">miss_rate_estimator_impl</span><span class="op">(</span><span class="va">xtab</span>, <span class="va">estimator</span>, <span class="va">event_level</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="fu"><a href="../reference/metric_vec_template.html">metric_vec_template</a></span><span class="op">(</span>
    metric_impl <span class="op">=</span> <span class="va">miss_rate_impl</span>,
    truth <span class="op">=</span> <span class="va">truth</span>,
    estimate <span class="op">=</span> <span class="va">estimate</span>,
    na_rm <span class="op">=</span> <span class="va">na_rm</span>,
    cls <span class="op">=</span> <span class="st">"factor"</span>,
    estimator <span class="op">=</span> <span class="va">estimator</span>,
    <span class="va">...</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="co"># This function switches between binary and multiclass implementations</span>
<span class="va">miss_rate_estimator_impl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">estimator</span>, <span class="va">event_level</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">estimator</span> <span class="op">==</span> <span class="st">"binary"</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">miss_rate_binary</span><span class="op">(</span><span class="va">data</span>, <span class="va">event_level</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="co"># Encapsulates the macro, macro weighted, and micro cases</span>
    <span class="va">wt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/developer-helpers.html">get_weights</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">estimator</span><span class="op">)</span>
    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">miss_rate_multiclass</span><span class="op">(</span><span class="va">data</span>, <span class="va">estimator</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">wt</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">miss_rate_binary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">event_level</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">col</span> <span class="op">&lt;-</span> <span class="fu">event_col</span><span class="op">(</span><span class="va">data</span>, <span class="va">event_level</span><span class="op">)</span>
  <span class="va">col2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="va">col</span><span class="op">)</span>
  
  <span class="va">tp</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">col</span>, <span class="va">col</span><span class="op">]</span>
  <span class="va">fn</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">col2</span>, <span class="va">col</span><span class="op">]</span>
  
  <span class="va">fn</span> <span class="op">/</span> <span class="op">(</span><span class="va">fn</span> <span class="op">+</span> <span class="va">tp</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">miss_rate_multiclass</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">estimator</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># We need tp and fn for all classes individually</span>
  <span class="co"># we can get this by taking advantage of the fact</span>
  <span class="co"># that tp + fn = colSums(data)</span>
  <span class="va">tp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
  <span class="va">tpfn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
  <span class="va">fn</span> <span class="op">&lt;-</span> <span class="va">tpfn</span> <span class="op">-</span> <span class="va">tp</span>
  
  <span class="co"># If using a micro estimator, we sum the individual</span>
  <span class="co"># pieces before performing the miss rate calculation</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">estimator</span> <span class="op">==</span> <span class="st">"micro"</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">tp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span>
    <span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">fn</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># return the vector </span>
  <span class="va">tp</span> <span class="op">/</span> <span class="op">(</span><span class="va">tp</span> <span class="op">+</span> <span class="va">fn</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>For the macro case, this separation of weighting from the core implementation might seem strange, but there is good reason for it. Some metrics are combinations of other metrics, and it is nice to be able to reuse code when calculating more complex metrics. For example, <code><a href="../reference/f_meas.html">f_meas()</a></code> is a combination of <code><a href="../reference/recall.html">recall()</a></code> and <code><a href="../reference/precision.html">precision()</a></code>. When calculating a macro averaged <code><a href="../reference/f_meas.html">f_meas()</a></code>, the weighting must be applied 1 time, at the very end of the calculation. <code>recall_multiclass()</code> and <code>precision_multiclass()</code> are defined similarly to how <code>miss_rate_multiclass()</code> is defined and returns the unweighted vector of calculations. This means we can directly use this in <code><a href="../reference/f_meas.html">f_meas()</a></code>, and then weight everything once at the end of that calculation.</p>
<p>Let’s try it out now:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># two class</span>
<span class="fu">miss_rate_vec</span><span class="op">(</span><span class="va">two_class_example</span><span class="op">$</span><span class="va">truth</span>, <span class="va">two_class_example</span><span class="op">$</span><span class="va">predicted</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.120155</span>

<span class="co"># multiclass</span>
<span class="fu">miss_rate_vec</span><span class="op">(</span><span class="va">fold1</span><span class="op">$</span><span class="va">obs</span>, <span class="va">fold1</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.5483506</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-frame-implementation-1">Data frame implementation<a class="anchor" aria-label="anchor" href="#data-frame-implementation-1"></a>
</h3>
<p>Luckily, the data frame implementation is as simple as the numeric case, we just need to add an extra <code>estimator</code> argument and pass that through. We’ll also use <code><a href="../reference/new-metric.html">new_class_metric()</a></code> to formalize <code>miss_rate()</code> as a class metric.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">miss_rate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"miss_rate"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">miss_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new-metric.html">new_class_metric</a></span><span class="op">(</span><span class="va">miss_rate</span>, direction <span class="op">=</span> <span class="st">"minimize"</span><span class="op">)</span>

<span class="va">miss_rate.data.frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, 
                                 <span class="va">truth</span>, 
                                 <span class="va">estimate</span>, 
                                 <span class="va">estimator</span> <span class="op">=</span> <span class="cn">NULL</span>, 
                                 <span class="va">na_rm</span> <span class="op">=</span> <span class="cn">TRUE</span>, 
                                 <span class="va">event_level</span> <span class="op">=</span> <span class="st">"first"</span>,
                                 <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/metric_summarizer.html">metric_summarizer</a></span><span class="op">(</span>
    metric_nm <span class="op">=</span> <span class="st">"miss_rate"</span>,
    metric_fn <span class="op">=</span> <span class="va">miss_rate_vec</span>,
    data <span class="op">=</span> <span class="va">data</span>,
    truth <span class="op">=</span> <span class="op">!</span><span class="op">!</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tidyeval-compat.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">truth</span><span class="op">)</span>,
    estimate <span class="op">=</span> <span class="op">!</span><span class="op">!</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tidyeval-compat.html" class="external-link">enquo</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span>, 
    estimator <span class="op">=</span> <span class="va">estimator</span>,
    na_rm <span class="op">=</span> <span class="va">na_rm</span>,
    event_level <span class="op">=</span> <span class="va">event_level</span>,
    <span class="va">...</span>
  <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Macro weighted automatically selected</span>
<span class="va">fold1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">miss_rate</span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span>
<span class="co">#&gt;   .metric   .estimator .estimate</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> miss_rate macro          0.548</span>

<span class="co"># Switch to micro</span>
<span class="va">fold1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">miss_rate</span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span>, estimator <span class="op">=</span> <span class="st">"micro"</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span>
<span class="co">#&gt;   .metric   .estimator .estimate</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> miss_rate micro          0.726</span>

<span class="co"># Macro weighted by resample</span>
<span class="va">hpc_cv</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Resample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">miss_rate</span><span class="op">(</span><span class="va">obs</span>, <span class="va">pred</span>, estimator <span class="op">=</span> <span class="st">"macro_weighted"</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 4</span></span>
<span class="co">#&gt;    Resample .metric   .estimator     .estimate</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Fold01   miss_rate macro_weighted     0.726</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Fold02   miss_rate macro_weighted     0.712</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Fold03   miss_rate macro_weighted     0.758</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Fold04   miss_rate macro_weighted     0.712</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Fold05   miss_rate macro_weighted     0.712</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Fold06   miss_rate macro_weighted     0.697</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Fold07   miss_rate macro_weighted     0.675</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Fold08   miss_rate macro_weighted     0.721</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Fold09   miss_rate macro_weighted     0.673</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Fold10   miss_rate macro_weighted     0.699</span>

<span class="co"># Error handling</span>
<span class="fu">miss_rate</span><span class="op">(</span><span class="va">hpc_cv</span>, <span class="va">obs</span>, <span class="va">VF</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `dplyr::summarise()`:</span></span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> Problem while computing `.estimate = metric_fn(truth = obs,</span>
<span class="co">#&gt;   estimate = VF, na_rm = na_rm, event_level = "first")`.</span>
<span class="co">#&gt; <span style="font-weight: bold;">Caused by error in `validate_class()`:</span></span>
<span class="co">#&gt; <span style="color: #BBBB00;">!</span> `estimate` should be a factor but a numeric was supplied.</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="using-custom-metrics-in-metric_set">Using custom metrics in <code>metric_set()</code><a class="anchor" aria-label="anchor" href="#using-custom-metrics-in-metric_set"></a>
</h2>
<p><code><a href="../reference/metric_set.html">metric_set()</a></code> validates that all metric functions are of the same metric type by checking the class of the function. If any metrics are not of the right class, <code><a href="../reference/metric_set.html">metric_set()</a></code> fails. By using <code><a href="../reference/new-metric.html">new_numeric_metric()</a></code> and <code><a href="../reference/new-metric.html">new_class_metric()</a></code> in the above custom metrics, they work out of the box without any additional adjustments.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">numeric_mets</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="va">mse</span>, <span class="va">rmse</span><span class="op">)</span>

<span class="fu">numeric_mets</span><span class="op">(</span><span class="va">solubility_test</span>, <span class="va">solubility</span>, <span class="va">prediction</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span>
<span class="co">#&gt;   .metric .estimator .estimate</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> mse     standard       0.521</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rmse    standard       0.722</span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

  </div></footer>
</body>
</html>
